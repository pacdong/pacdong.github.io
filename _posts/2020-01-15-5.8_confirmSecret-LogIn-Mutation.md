---
title: "Authorization Routes 마무리"
excerpt: "Log In, Auth 인증 마무리"

categories:
  - 인스타그램 클론코딩
tags:
  - Instagram
  - Clone
  - Coding
  - React
  - React-Native
last_modified_at: 2020-01-15T08:17:30-18:30
---

노마드 코더의 프론트엔드 첫번째 스테이지 Authorization Routes를 마무리 하겠습니다.
로그인 파트 정리단으로 생각하시면 될 것 같습니다. 우선 몇가지 에러 사항에 대해 설명드리고자 합니다.  

## Error 1. < useMutation >
노마드 코더가 이 강의를 찍을 당시랑 현재랑 시간차이가 있는데요. 그 만큼의 시간 덕분에 발생한 몇가지 에러를 다루어 보겠습니다. 그 첫번째로는 바로 `useMuatation` 에러 입니다.
노마드 코더는 당시 본인의 코드에서 useMutation을 사용할 때 
`src/Routes/Auth/AuthContainer.js`
```javascript
 const requestSecretMutation = useMutation(LOG_IN, {
    variables: { email: email.value }
  });
  const createAccountMutation = useMutation(CREATE_ACCOUNT, {
    variables: {
      email: email.value,
      username: username.value,
      firstName: firstName.value,
      lastName: lastName.value
    }
```
이렇게 requestSecretMutation을 [] 감싸지 않고 사용 했었습니다. 이는 함수가 업데이트 되면서 []배열로 만들어 주도록 업데이트 되었습니다. 예전 버전에서는 useMutation을 함수처럼 사용합니다. 하지만 현재 버전에서는 `[function, {loading ...}]` 처럼 function과 여러 설정값을 가지고 있는 object로 return되기 때문에 예전버전과 같이 사용할 경우에 function이 아니라는 에러를 띄우게 됩나다.

해결 방법은 간단합니다. 
`src/Routes/Auth/AuthContainer.js`
```javascript
 const [requestSecretMutation] = useMutation(LOG_IN, {
    variables: { email: email.value }
  });
  const [createAccountMutation] = useMutation(CREATE_ACCOUNT, {
    variables: {
      email: email.value,
      username: username.value,
      firstName: firstName.value,
      lastName: lastName.value
    }
```
위 처럼 배열 형태의 `[requestSecretMutation]`로 만들어 주는 것입니다. 이렇게 하는 이유는 return되는 값들 중에 function으로만 사용한다는 의미가 됩니다. 따라서 이렇게 함수로 만든 후 호출하여 사용하면 됩니다.


## Error 2. < 서버에 데이터 요청 >

https://localhost:4000으로 전달하여 GraphQL <-> Apollo 백엔드와 프론트엔드를 연결하여 사용하도록 강의에서 진행하고 있고 또 저도 그렇게 사용하였습니다. 하지만 아래의 이미지와 같이 이러한 에러가 뜨는 경우가 있습니다. 
<center><img src="/assets/images/instagramClone/corsProblem.png" width="100%" alt="승인폴더구성"></center>
<br>
에러 메시지는 다음과 같습니다.   *Error Message:"Access to fetch at 'http://localhost:4000/' from origin 'http://localhost:3000' has been blocked by CORS policy: Response to preflight request doesn't pass access control check: No 'Access-Control-Allow-Origin' header is present on the requested resource. If an opaque response serves your needs, set the request's mode to 'no-cors' to fetch the resource with CORS disabled."*   과연 CORS?가 무엇일까요? 

Cross Origin Resource Sharing의 약자로 도메인 또는 포트가 다른 서버의 자원을 요청하는 매커니즘을 말합니다. 요청을 할 때 cross-origin-HTTP에 의해 요청되나 'same-origin-policy'때문에 CORS와 같은 상황이 발생하였을 때 외부 데이터를 브라우저에서 보안 목적으로 차단하는 경우가 있습니다. 이 때문에 정상적으로 데이터를 받을 수 없습니다.

>동일 출처 정책(same-origin policy)
>불러온문서나 스크립트가 다른 출처에서 가져온 리소스와 상호작용하는 것을 제한하는 중요한 보안 방식입니다. 이것은 잠재적 악성 문서를 격리하여, 공격 경로를 줄이는데 도움이 됩니다.
>
>-- MDN web docs --

저는 실습하는 동안 localhost:4000에서 server를 실행하였고 localhost:3000에서 react를 실행하고 있었기에 포트가 달라 CORS가 발생할 여지가 충분한 상황이었습니다. 해결방법으로는 서버와 클라이언트가 같은 도메인과 포트를 사용하면 됩니다. 이 방법이 불가능하면 미들웨어 CORS를 추가하면 됩니다. 추가하는 방법은 아래와 같습니다.

`yarn add cors` 로 cors를 설치한 뒤에 BackEnd 서버에 아래와 같은 미들웨어를 추가하면 됩니다. 이 때 노마드 코더의 serve.js에 추가하도록 합니다. 자세한 사항은 [여기 문서](https://www.prisma.io/blog/enabling-cors-for-express-graphql-apollo-server-1ef999bfb38d)로 접속하시면 나와 있습니다. 아래는 백엔드의 server.js에 코드를 추가하시면 CORS에러는 잡을 수 있습니다.


`BackEnd:prismagram/src/server.js`
```javascript 
import "./env";
import { GraphQLServer } from "graphql-yoga";
import logger from "morgan";
import schema from "./schema";
import "./passport";
import { authenticateJwt } from "./passport";
import { isAuthenticated } from "./middlewares";
import { uploadMiddleware, uploadController } from "./upload";

const PORT = process.env.PORT || 4000;

const server = new GraphQLServer({
  schema,
  context: ({ request }) => ({ request, isAuthenticated })
});

// 여기서부터 추가된 코드입니다.
const express = require('express');
const cors = require('cors');

const app = express();
const corsOptions = {
  origin: 'http://localhost:3000',
  credentials: true,
};

app.use(cors(corsOptions));
//여기까지..

server.express.use(logger("dev"));
server.express.use(authenticateJwt);
server.express.post("/api/upload", uploadMiddleware, uploadController);

server.start({ port: PORT }, () =>
  console.log(`✅ Server running on http://localhost:${PORT}`)
);
```
위와 같이 BackEnd GraphQL 서버에 추가하시면 CORS 에러를 해결할 수 있습니다.

## ConfirmSecret

노마드 코더가 작성한 로그인 화면에서 로그인 되는 과정입니다.
1. 이메일 로그인 창에서 params로 email 값을 email.value에 넘겨줍니다.


### 참고자료

- [academy.nomadcoders.InstagramClonCoding](https://academy.nomadcoders.co/courses/enrolled/503371)
